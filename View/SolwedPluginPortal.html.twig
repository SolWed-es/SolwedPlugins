{% extends "Master/MenuBghTemplate.html.twig" %}

{% block css %}
    {{ parent() }}
    <style>
        .plugin-card {
            transition: all 0.3s ease;
            border-left: 4px solid #007bff;
        }
        .plugin-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .plugin-card.installed {
            border-left-color: #28a745;
        }
        .plugin-card.update-available {
            border-left-color: #ffc107;
        }
        .plugin-card.incompatible {
            border-left-color: #dc3545;
        }
        .plugin-icon {
            font-size: 2rem;
            color: #6c757d;
        }
        .plugin-badge {
            font-size: 0.8rem;
        }
        .plugin-description {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .plugin-actions {
            min-width: 140px;
            text-align: right;
        }
        .search-box {
            max-width: 300px;
        }
        .filter-buttons .btn {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-installed {
            background-color: #28a745;
        }
        .status-update {
            background-color: #ffc107;
        }
        .status-not-installed {
            background-color: #6c757d;
        }
        .status-incompatible {
            background-color: #dc3545;
        }
    </style>
{% endblock %}

{% block bodyHeaderOptions %}
    {{ parent() }}
    <div class="container-fluid mb-4">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="h3 mb-0">
                    <i class="{{ fsc.getPageData()['icon'] }} mr-2" aria-hidden="true"></i>
                    Solwed Plugins (FS {{ fsc.getFacturaScriptsVersion() }})
                </h1>
                <p class="text-muted mb-0">Gestiona e instala plugins desde el Github repo</p>
            </div>
            <div class="col-md-6 text-md-right mt-2 mt-md-0">
                <div class="btn-group">
                    <a class="btn btn-outline-secondary" href="{{ fsc.url() }}" title="{{ trans('refresh') }}">
                        <i class="fas fa-sync-alt mr-1"></i> {{ trans('refresh') }}
                    </a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block body %}
    {{ parent() }}
    <div class="container-fluid">
        <!-- Filters and Search -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="filter-buttons">
                    <button class="btn btn-outline-primary active" data-filter="all" title="{{ trans('all') }}">
                        <i class="fas fa-boxes mr-1"></i> {{ trans('all') }}
                    </button>
                    <button class="btn btn-outline-success" data-filter="installed" title="{{ trans('installed') }}">
                        <i class="fas fa-check-circle mr-1"></i> {{ trans('installed') }}
                    </button>
                    <button class="btn btn-outline-warning" data-filter="updates" title="{{ trans('updates-available') }}">
                        <i class="fas fa-sync-alt mr-1"></i> {{ trans('updates-available') }}
                    </button>
                    <button class="btn btn-outline-danger" data-filter="incompatible">
                        <i class="fas fa-exclamation-triangle mr-1"></i> Incompatible
                    </button>
                </div>
            </div>
            <div class="col-md-6 mt-3 mt-md-0 d-flex justify-content-md-end">
                <div class="input-group search-box">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                    </div>
                    <input type="text" id="pluginSearch" class="form-control" placeholder="Buscar plugins...">
                </div>
            </div>
        </div>

        <!-- Plugin Cards -->
        <div class="row" id="pluginContainer">
            {% for plugin in fsc.pluginList %}
                <div class="col-lg-4 col-md-6 mb-4 plugin-item" 
                     data-name="{{ plugin.name|lower }}" 
                     data-status="{% if not plugin.compatible %}incompatible{% elseif plugin.update_available %}updates{% elseif plugin.installed %}installed{% else %}available{% endif %}">
                    <div class="card plugin-card h-100 {%
                        if not plugin.compatible %}incompatible{%
                        elseif plugin.update_available %}update-available{%
                        elseif plugin.installed %}installed{%
                        else %}available{%
                        endif
                    %}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-cube plugin-icon mr-2"></i>
                                    <div>
                                        <h5 class="card-title mb-0">{{ plugin.name }}</h5>
                                        <div class="text-muted small">v{{ plugin.version }}</div>
                                    </div>
                                </div>
                                <div class="d-flex">
                                    {% if not plugin.compatible %}
                                        <span class="badge badge-danger plugin-badge">
                                            <i class="fas fa-exclamation-triangle mr-1"></i> {{ trans('incompatible') }}
                                        </span>
                                    {% elseif plugin.update_available %}
                                        <span class="badge badge-warning plugin-badge">
                                            <i class="fas fa-sync-alt mr-1"></i> {{ trans('update') }}
                                        </span>
                                    {% elseif plugin.installed %}
                                        <span class="badge badge-success plugin-badge">
                                            <i class="fas fa-check-circle mr-1"></i> {{ trans('installed') }}
                                        </span>
                                    {% else %}
                                        <span class="badge badge-info plugin-badge">
                                            <i class="fas fa-download mr-1"></i> {{ trans('available') }}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <p class="card-text plugin-description">
                                {{ plugin.description }}
                            </p>
                            
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div class="text-muted small">
                                    <i class="far fa-calendar-alt mr-1"></i>
                                    Updated: {{ plugin.last_updated }}
                                </div>
                                
                                <div class="plugin-actions">
                                    {% if plugin.installed %}
                                        {% if plugin.update_available %}
                                            <a href="{{ fsc.url() }}?action=update&plugin={{ plugin.name }}&multireqtoken={{ formToken(false) }}"
                                               class="btn btn-warning btn-sm"
                                               data-confirm-message="{{ trans('confirm-update-plugin') }}?">
                                                <i class="fas fa-sync-alt mr-1"></i> {{ trans('update') }}
                                            </a>
                                        {% else %}
                                            <button class="btn btn-success btn-sm" disabled>
                                                <i class="fas fa-check mr-1"></i> {{ trans('installed') }}
                                            </button>
                                        {% endif %}
                                    {% else %}
                                        {% if not plugin.compatible %}
                                            <a href="{{ fsc.url() }}?action=install&plugin={{ plugin.name }}&multireqtoken={{ formToken(false) }}"
                                               class="btn btn-danger btn-sm"
                                               data-confirm-message="{{ trans('warning-plugin-incompatible') }}\n\n{{ plugin.compatibility_message }}\n\n{{ trans('confirm-install-anyway') }}">
                                                <i class="fas fa-exclamation-triangle mr-1"></i> {{ trans('install-anyway') }}
                                            </a>
                                        {% else %}
                                            <a href="{{ fsc.url() }}?action=install&plugin={{ plugin.name }}&multireqtoken={{ formToken(false) }}"
                                               class="btn btn-primary btn-sm"
                                               data-confirm-message="{{ trans('confirm-install-plugin') }}?">
                                                <i class="fas fa-download mr-1"></i> {{ trans('install') }}
                                            </a>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if not plugin.compatible %}
                                <div class="alert alert-warning mt-3 mb-0 py-2 small" role="alert">
                                    <i class="fas fa-exclamation-circle mr-1"></i>
                                    {{ plugin.compatibility_message }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle fa-2x mb-3"></i>
                        <h4>No plugins found</h4>
                        <p class="mb-0">No plugins are available in your repository yet.</p>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        $(document).ready(function() {
            // Search functionality
            $('#pluginSearch').on('keyup', function() {
                var value = $(this).val().toLowerCase();
                $('.plugin-item').filter(function() {
                    var pluginName = $(this).data('name');
                    $(this).toggle(pluginName.indexOf(value) > -1);
                });
            });
            
            // Filter functionality
            $('.filter-buttons button').on('click', function() {
                var filter = $(this).data('filter');
                
                // Update active button
                $('.filter-buttons button').removeClass('active');
                $(this).addClass('active');
                
                // Show/hide plugins based on filter
                if (filter === 'all') {
                    $('.plugin-item').show();
                } else {
                    $('.plugin-item').hide();
                    $('.plugin-item[data-status="' + filter + '"]').show();
                }
            });
            
            // Add confirmation for install/update actions

            $('#pluginContainer').on('click', 'a[data-confirm-message]', function(e) {
                e.preventDefault();
                const button = $(this);
                const url = button.attr('href');
                const message = button.data('confirm-message');
                const action = button.text().trim();
                const isDanger = button.hasClass('btn-danger');
                
                bootbox.confirm({
                    title: "{{ trans('confirm-action')|raw }}",
                    message: message.replace(/\n/g, '<br/>'),
                    closeButton: false,
                    buttons: {
                        cancel: {
                            label: "<i class='fas fa-times'></i> {{ trans('cancel') }}"
                        },
                        confirm: {
                            label: "<i class='fas fa-check'></i> " + action.charAt(0).toUpperCase() + action.slice(1),
                            className: isDanger ? 'btn-danger' : 'btn-primary'
                        }
                    },
                    callback: function(result) {
                        if (result) {
                            animateSpinner('add');
                            window.location = url;
                        }
                    }
                });
            });
        });
    </script>
{% endblock %}